(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[0],[,,,,,,,,,,,,,,,function(e,t,n){e.exports=n(28)},,,,,function(e,t,n){},function(e,t,n){},,function(e,t,n){},function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=24},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),c=n(9),o=n.n(c),i=(n(20),n(10)),u=n(11),s=n(13),l=n(14),f=n(1),d=function(){var e=Object(r.useState)(30),t=Object(f.a)(e,2),n=t[0],c=t[1];return Object(r.useEffect)((function(){n>0?setTimeout((function(){c(n-1)}),1e3):window.location.reload()})),a.a.createElement("div",null,a.a.createElement("h1",null,"Unrecoverable error occurred."),a.a.createElement("p",null,"Will auto reload in ",n," sec."))},m=(n(21),n(2)),p=n.n(m),v=n(3),g=function(){var e=window.crypto.getRandomValues(new Uint8Array(32));return Array.from(e).map((function(e){return e.toString(16).padStart(2,"0")})).join("")},h=function(){return 1e3+window.crypto.getRandomValues(new Uint16Array(1))[0]%9e3},b=function(e){try{var t=new URL(e).hash.slice(1);return new URLSearchParams(t).get("roomId")}catch(n){return null}},y=(n(23),n(12)),E=n.n(y),I=function(e,t){return"".concat(e,"_").concat(t)},O=function(e){return Number(e.split("_")[1])},w=function(e){return O(e.peer)},j=function(e){return O(e)<5},k=function(e,t,n){var r=!1,a=null,c=null,o=function(){var e=new Map;return{addConn:function(t){e.set(t.peer,{conn:t,connected:!1})},markConnected:function(t){var n=e.get(t.peer);n&&(n.connected=!0)},isConnected:function(t){var n=e.get(t);return!!n&&n.connected},hasConn:function(t){return e.has(t)},delConn:function(t){var n=e.get(t.peer);n&&n.conn===t&&e.delete(t.peer)},getConnectedPeerJsIds:function(){return Array.from(e.keys()).filter((function(t){var n;return null===(n=e.get(t))||void 0===n?void 0:n.connected}))},forEachConnectedConns:function(t){Array.from(e.values()).forEach((function(e){e.connected&&t(e.conn)}))},clearAll:function(){e.size&&console.log("connectionMap garbage:",e),e.clear()}}}(),i=function(){if(!r){var e=o.getConnectedPeerJsIds().map(O);t({type:"CONNECTED_PEERS",peerIds:e})}},u=function(e){if(!r&&a&&a.id!==e&&!o.hasConn(e)){console.log("connectPeer",e);var t=a.connect(e,{serialization:"json"});s(t)}},s=function(t){o.isConnected(t.peer)?t.close():(o.addConn(t),t.on("open",(function(){o.markConnected(t),i(),c&&t.send({data:c,peers:o.getConnectedPeerJsIds()})})),t.on("data",(function(a){return function(t,a){if(!r)try{var c=w(t);a&&"object"===typeof a&&(n(c,a.data),Array.isArray(a.peers)&&a.peers.forEach((function(t){(function(e,t){return"string"===typeof t&&t.startsWith("".concat(e,"_"))})(e,t)&&u(t)})))}catch(o){console.error("handlePayload",o)}}(t,a)})),t.on("close",(function(){if(o.delConn(t),console.log("dataConnection closed",t),i(),0===o.getConnectedPeerJsIds().length)f(!0);else if(j(t.peer)&&a&&!a.disconnected&&!j(a.id)){var e=30+Math.floor(60*Math.random());console.log("Disconnected seed peer: ".concat(O(t.peer),", reinit in ").concat(e,"sec...")),setTimeout(f,1e3*e)}})))},l=function n(){var c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!r&&!a){o.clearAll(),t({type:"INITIALIZING_PEER",index:c});var i=c<5,l=i?c:h(),f=I(e,l);console.log("initMyPeer start",c,f);var d=new E.a(f);a=d,d.on("open",(function(){a=d,t({type:"CONNECTING_SEED_PEERS"});for(var n=0;n<5;n+=1){var r=I(e,n);u(r)}})),d.on("error",(function(e){"unavailable-id"===e.type?(a=null,d.destroy(),n(c+1)):"peer-unavailable"===e.type||("network"===e.type?(console.log("initMyPeer network error",c,e),d.destroy()):(console.error("initMyPeer",c,e.type,e),t({type:"UNKNOWN_ERROR"})))})),d.on("connection",(function(e){a===d&&(console.log("new connection received",e),t({type:"NEW_CONNECTION",peerId:w(e)}),s(e))})),d.on("disconnected",(function(){console.log("initMyPeer disconnected",c),setTimeout((function(){a!==d||d.destroyed||(console.log("initMyPeer reconnecting",c),t({type:"RECONNECTING"}),d.reconnect())}),5e3)})),d.on("close",(function(){a===d?(console.log("initMyPeer closed, re-initializing",c),a=null,setTimeout(n,1e4)):console.log("initMyPeer closed, ignoring",c)}))}};l();var f=function(t){if(a&&!a.disconnected){if(!t){if(j(a.id))return;if(Array.from(Array(5).keys()).every((function(t){var n=I(e,t);return o.isConnected(n)})))return void i()}var n=a;a=null,n.destroy(),l()}};return{broadcastData:function(e,t){if(!r){t&&(c=e);var n=o.getConnectedPeerJsIds();o.forEachConnectedConns((function(t){try{t.send({data:e,peers:n})}catch(r){console.error("broadcastData",r)}}))}},dispose:function(){r=!0,a&&a.destroy()}}},C=new Map,S=function(e,t,n){var r=C.get(e);if(!r){var a=new Set,c=new Set,o=k(e,(function(e){a.forEach((function(t){t(e)}))}),(function(e,t){c.forEach((function(n){n(e,t)}))}));r={room:o,networkStatusListeners:a,dataListeners:c,count:0},C.set(e,r)}t&&r.networkStatusListeners.add(t),n&&r.dataListeners.add(n),r.count+=1;return{broadcastData:r.room.broadcastData,unregister:function(){t&&r.networkStatusListeners.delete(t),n&&r.dataListeners.delete(n),r.count-=1,r.count<=0&&(r.room.dispose(),C.delete(e))}}},A=function(e){var t=Object(r.useRef)(),n=Object(r.useCallback)((function(){t.current&&t.current.apply(t,arguments)}),[]);return Object(r.useEffect)((function(){var n=S(e),r=n.broadcastData,a=n.unregister;return t.current=r,a}),[e]),n},N=function(e,t){var n=Object(r.useState)(),a=Object(f.a)(n,2),c=a[0],o=a[1];return Object(r.useEffect)((function(){return S(e,void 0,(function(e,n){t(n)&&o(n)})).unregister}),[e,t]),c},R=function(e){return new Promise((function(t){return setTimeout(t,e)}))},x=function(){var e=Object(v.a)(p.a.mark((function e(t,n){var r,a,c,o,i,u,s,l,f;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"===typeof ImageCapture){e.next=21;break}return r=new ImageCapture(n),e.next=4,R(2e3);case 4:return e.prev=4,e.next=7,r.takePhoto();case 7:return c=e.sent,e.next=10,createImageBitmap(c);case 10:a=e.sent,e.next=18;break;case 13:return e.prev=13,e.t0=e.catch(4),e.next=17,r.grabFrame();case 17:a=e.sent;case 18:return o=a.width,i=a.height,e.abrupt("return",{srcImg:a,srcW:o,srcH:i});case 21:return(u=document.getElementById("internal-video")).style.display="block",u.srcObject=t,e.next=26,R(2e3);case 26:return s=u,l=u.videoWidth,f=u.videoHeight,e.abrupt("return",{srcImg:s,srcW:l,srcH:f});case 30:case"end":return e.stop()}}),e,null,[[4,13]])})));return function(t,n){return e.apply(this,arguments)}}(),T=function(){var e=Object(v.a)(p.a.mark((function e(t){var n,r,a,c,o,i,u,s,l,f,d,m,v,g,h,b;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,a=r.getVideoTracks()[0],c=document.getElementById("internal-canvas"),o=c.getContext("2d"),i=72,u=72,c.width=i,c.height=u,e.next=13,x(r,a);case 13:return s=e.sent,l=s.srcImg,f=s.srcW,d=s.srcH,m=Math.max(i/f,u/d),v=Math.min(f,i/m),g=Math.min(d,u/m),h=(f-v)/2,b=(d-g)/2,o.drawImage(l,h,b,v,g,0,0,i,u),a.stop(),e.abrupt("return",c.toDataURL("image/png"));case 25:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),M=function(){var e=Object(v.a)(p.a.mark((function e(){var t,n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t=e.sent,n=t.filter((function(e){return"videoinput"===e.kind})).map((function(e){return{label:e.label,deviceId:e.deviceId}})),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),P=(n(25),n(5)),D=n(6),L=function(e){return e&&"object"===typeof e&&"string"===typeof e.userId&&"string"===typeof e.image&&function(e){return e&&"object"===typeof e&&"string"===typeof e.nickname&&"string"===typeof e.message}(e.info)},U=a.a.memo((function(e){var t=e.roomId,n=e.userId,c=e.nickname,o=e.statusMesg,i=function(e,t,n,a,c){var o=Object(r.useState)(),i=Object(f.a)(o,2),u=i[0],s=i[1],l=Object(r.useState)([]),d=Object(f.a)(l,2),m=d[0],g=d[1],h=Object(r.useState)(),b=Object(f.a)(h,2),y=b[0],E=b[1],I=Object(r.useRef)({nickname:n,message:a});if(I.current={nickname:n,message:a},y)throw y;var O=A(e),w=N(e,L),j=Object(r.useMemo)((function(){return w&&Object(D.a)({},w,{received:Date.now(),obsoleted:!1})}),[w]);if(j){var k=m.find((function(e){return e.userId===j.userId}));k?k.received!==j.received&&g(m.map((function(e){return e.userId===j.userId?j:e}))):g([].concat(Object(P.a)(m),[j]))}return Object(r.useEffect)((function(){var e=function(){var e=Date.now()-12e4;g((function(t){var n=!1,r=t.map((function(t){return t.received<e&&!t.obsoleted?(n=!0,Object(D.a)({},t,{obsoleted:!0})):t}));return n?r:t}))},n=function(){var n=Object(v.a)(p.a.mark((function n(){var r,a;return p.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,e(),n.next=4,T(c);case 4:r=n.sent,s(r),a={userId:t,image:r,info:I.current},O(a,!0),n.next=14;break;case 10:n.prev=10,n.t0=n.catch(0),console.error(n.t0),E(n.t0);case 14:case"end":return n.stop()}}),n,null,[[0,10]])})));return function(){return n.apply(this,arguments)}}();n();var r=setInterval(n,12e4);return function(){clearTimeout(r)}}),[e,t,c,O]),{myImage:u,roomImages:m}}(t,n,c,o,e.deviceId),u=i.myImage,s=i.roomImages;return a.a.createElement("div",{className:"FaceImage-container"},a.a.createElement("div",{className:"FaceImages-card"},a.a.createElement("img",{src:u||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQI12NgYAAAAAMAASDVlMcAAAAASUVORK5CYII=",className:"FaceImages-photo",alt:"myself"}),a.a.createElement("div",{className:"FaceImages-name"},c),a.a.createElement("div",{className:"FaceImages-mesg"},o)),s.map((function(e){return a.a.createElement("div",{key:e.userId,className:"FaceImages-card",style:{opacity:e.obsoleted?.2:1}},a.a.createElement("img",{src:e.image,className:"FaceImages-photo",alt:"friend"}),a.a.createElement("div",{className:"FaceImages-name"},e.info.nickname),a.a.createElement("div",{className:"FaceImages-mesg"},e.info.message))})))})),F=(n(26),function(e){return e&&"object"===typeof e&&"string"===typeof e.userId&&"string"===typeof e.nickname&&"number"===typeof e.chatSeq&&"string"===typeof e.chatText&&("undefined"===typeof e.chatInReplyTo||"string"===typeof e.chatInReplyTo.userId||"number"===typeof e.chatInReplyTo.chatSeq)}),_=function(e,t){var n=t[1]-e[1];return 0===n?e[0].length-t[0].length:n},q=["\ud83d\udc4d","\u2764\ufe0f","\ud83d\ude01","\ud83d\ude0e","\ud83e\udd23","Send a PR!"],W=function(e){var t=e.text,n=e.onClick;return a.a.createElement("button",{type:"button",onClick:function(){return n(t)}},a.a.createElement("span",{"aria-label":"Reaction"},t))},J=a.a.memo((function(e){var t=e.chatList,n=e.replyChat;return a.a.createElement("ul",{className:"MomentaryChat-list"},t.map((function(e){var t=function(t){return n(t,e.replyTo)};return a.a.createElement("li",{key:e.key},e.nickname," - ",e.text," ",JSON.stringify(e.replies),q.map((function(e){return a.a.createElement(W,{key:e,text:e,onClick:t})})))})))})),V=a.a.memo((function(e){var t=function(e,t,n){var a=Object(r.useRef)(1),c=Object(r.useRef)(new Map),o=Object(r.useState)([]),i=Object(f.a)(o,2),u=i[0],s=i[1],l=Object(r.useCallback)((function(e){if((c.current.get(e.userId)||0)<e.chatSeq)if(c.current.set(e.userId,e.chatSeq),e.chatInReplyTo){var t=e.chatText,n=e.chatInReplyTo;s((function(e){return e.map((function(e){if(e.replyTo.userId===n.userId&&e.replyTo.chatSeq===n.chatSeq){var r=new Map(e.replies);r.set(t,(r.get(t)||0)+1);var a=Object(P.a)(r.entries());return a.sort(_),Object(D.a)({},e,{replies:a})}return e}))}))}else{var r={key:"".concat(e.userId,"_").concat(e.chatSeq),replyTo:{userId:e.userId,chatSeq:e.chatSeq},nickname:e.nickname,text:e.chatText,replies:[]};s((function(e){return[r].concat(Object(P.a)(e)).slice(0,100)}))}}),[]),d=A(e),m=N(e,F);return Object(r.useEffect)((function(){m&&l(m)})),{chatList:u,sendChat:Object(r.useCallback)((function(e){var r={userId:t,nickname:n,chatSeq:a.current,chatText:e};a.current+=1,d(r),l(r)}),[d,t,n,l]),replyChat:Object(r.useCallback)((function(e,r){var c={userId:t,nickname:n,chatSeq:a.current,chatText:e,chatInReplyTo:r};a.current+=1,d(c),l(c)}),[d,t,n,l])}}(e.roomId,e.userId,e.nickname),n=t.chatList,c=t.sendChat,o=t.replyChat,i=Object(r.useState)(""),u=Object(f.a)(i,2),s=u[0],l=u[1];return a.a.createElement("div",{className:"MomentaryChat-container"},a.a.createElement("form",{onSubmit:function(e){e.preventDefault(),s&&(c(s),l(""))}},a.a.createElement("input",{value:s,onChange:function(e){return l(e.target.value)},placeholder:"Enter chat message"}),a.a.createElement("button",{type:"submit",disabled:!s},"Send")),a.a.createElement(J,{chatList:n,replyChat:o}))})),B=function(e){try{return window.localStorage.getItem(e)||""}catch(t){return""}}("nickname"),H=function(e){var t=e.roomId,n=e.userId,c=Object(r.useState)(B),o=Object(f.a)(c,2),i=o[0],u=o[1],s=Object(r.useState)(""),l=Object(f.a)(s,2),d=l[0],m=l[1];Object(r.useEffect)((function(){!function(e){var t=window.location.hash.slice(1),n=new URLSearchParams(t);n.set("roomId",e),window.location.hash=n.toString()}(t)}),[t]);var g=Object(r.useState)(),h=Object(f.a)(g,2),b=h[0],y=h[1],E=Object(r.useState)(!0),I=Object(f.a)(E,2),O=I[0],w=I[1],j=function(){var e=Object(r.useState)([]),t=Object(f.a)(e,2),n=t[0],a=t[1];return Object(r.useEffect)((function(){Object(v.a)(p.a.mark((function e(){var t;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,M();case 2:t=e.sent,a(t);case 4:case"end":return e.stop()}}),e)})))()}),[]),n}(),k=function(e){var t=Object(r.useState)(),n=Object(f.a)(t,2),a=n[0],c=n[1];if(a&&"UNKNOWN_ERROR"===a.type)throw new Error("Network Error");return Object(r.useEffect)((function(){return S(e,c).unregister}),[e]),a}(t),C="remote-faces://".concat(window.location.href.replace(/^https:\/\//,""));return a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"SingleRoom-status"},JSON.stringify(k)),a.a.createElement("div",{className:"SingleRoom-room-info"},O?a.a.createElement(a.a.Fragment,null,a.a.createElement("button",{type:"button",onClick:function(){return w(!1)}},"Hide config"),a.a.createElement("div",null,"Link to this room:",a.a.createElement("input",{value:window.location.href,readOnly:!0}),"(Share this link with your colleagues)",a.a.createElement("a",{href:C},"Open App")),a.a.createElement("div",{className:"SingleRoom-nickname"},"Your Name:"," ",a.a.createElement("input",{defaultValue:B,onChange:function(e){u(e.target.value),function(t,n){try{window.localStorage.setItem(t,n)}catch(e){console.log("Failed to save string to localStorage",e)}}("nickname",e.target.value)}})),a.a.createElement("div",{className:"SingleRoom-statusmesg"},"Your Status:"," ",a.a.createElement("input",{onChange:function(e){m(e.target.value)},placeholder:"Enter status message"})),a.a.createElement("div",null,"Select Camera:"," ",a.a.createElement("select",{onChange:function(e){return y(e.target.value)}},j.map((function(e){return a.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)}))))):a.a.createElement("button",{type:"button",onClick:function(){return w(!0)}},"Show config")),a.a.createElement(U,{roomId:t,userId:n,deviceId:b,nickname:i,statusMesg:d}),a.a.createElement(V,{roomId:t,userId:n,nickname:i}))},G=function(){var e=window.location.hash.slice(1);return new URLSearchParams(e).get("roomId")}(),K=g(),Y=function(){var e=Object(r.useState)(G),t=Object(f.a)(e,2),n=t[0],c=t[1],o=Object(r.useState)(""),i=Object(f.a)(o,2),u=i[0],s=i[1];return n?a.a.createElement(H,{roomId:n,userId:K}):a.a.createElement("div",{className:"SingleRoomEntrance-init"},a.a.createElement("button",{type:"button",onClick:function(){c(g())}},"Create a new room"),"OR",a.a.createElement("input",{value:u,onChange:function(e){return s(e.target.value)},placeholder:"Enter room link..."}),a.a.createElement("button",{type:"button",onClick:function(){c(b(u))},disabled:!b(u)},"Enter room"))},z=(n(27),function(e){Object(l.a)(n,e);var t=Object(s.a)(n);function n(){var e;Object(i.a)(this,n);for(var r=arguments.length,a=new Array(r),c=0;c<r;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={hasError:!1},e}return Object(u.a)(n,[{key:"render",value:function(){var e=this.props.children;return this.state.hasError?a.a.createElement(d,null):e}}],[{key:"getDerivedStateFromError",value:function(){return{hasError:!0}}}]),n}(a.a.Component)),Q=function(){return a.a.createElement("div",{className:"App"},a.a.createElement(z,null,a.a.createElement(Y,null)))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(a.a.StrictMode,null,a.a.createElement(Q,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}],[[15,1,2]]]);
//# sourceMappingURL=main.f61f1c44.chunk.js.map